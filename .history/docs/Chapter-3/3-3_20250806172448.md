## 3.3 贝尔曼最优公式

!!! note 
    这一节公式非常多，建议读者仔细阅读

用于分析最优策略和最优状态值的工具是贝尔曼最优公式(BOE)。通过求解该公式，可以获得最优策略和最优状态值。接下来我们给出了BOE的表达式，并对其进行了详细分析。

对于每个$s\in\mathcal{S}$，BOE的元素级表达式为

$$\begin{aligned}
    v(s) &= \max_{\pi \in \Pi(\mathcal{S})} \sum_{a \in A} \pi(a|s) \left( \sum_{r \in \mathcal{R}} p(r|s, a) r + \gamma \sum_{s' \in S} p(s'|s, a) v(s') \right) \\
&= \max_{\pi \in \Pi(\mathcal{S})} \sum_{a \in A} \pi(a|s) q(s, a), 
\end{aligned}\tag{3.1}$$

其中$v(s),v(s^\prime)$是待求解的未知变量，

$$q(s, a) = \sum_{r \in \mathcal{R}} p(r|s, a) r + \gamma \sum_{s' \in \mathcal{S}} p(s'|s, a) v(s').$$

这里,$π(s)$表示状态$s$的策略，而$\Pi(s)$是$s$的所有可能策略的集合。

BOE是分析最优策略的一个优雅而强大的工具。然而，要理解这个方程可能并非易事。例如，这个方程有两个未知变量$v(s)$和$\pi(a|s)$的情况。对于初学者来说，如何从一个方程中解出两个未知变量可能会令人困惑。BOE实际上是一个特殊的贝尔曼公式。但由于其表达式与贝尔曼公式的表达式有很大的不同，因此要认识到这一点并不容易。我们还需要回答关于贝尔曼最优方程的以下基本问题。

- 存在性：这个方程是否有解？
- 唯一性：解是否唯一？ 
- 算法：如何求解这个方程？
- 最优性：解与最优策略有何关系？
  
一旦我们能够回答这些问题，我们就能清楚地理解最优状态值和最优策略。

### 3.3.1 方程右侧的优化问题

接下来，我们将阐明如何解决公式$(3.1)$中BOE右侧的优化问题。初看之下，初学者可能会对在一个方程中如何求解两个未知变量$v(s)$和$π(a|s)$感到困惑。实际上，这两个未知变量可以逐一求解。下面的例子说明了这个结论。

!!! note 
    **例子3.1** 考虑两个未知变量$x,y\in\mathbb{R}$，满足

    $$x=\max_{y\in\mathbb{R}}(2x-1-y^{2}).$$

    第一步是求解方程右边的$y$。不管$x$的值如何，我们总是有$max_y(2x − 1 − y^2)= 2x − 1$，其中当$y = 0$时达到最大值。第二步是解$x$。当$y = 0$时，方程变为$x = 2x − 1$，因此$x = 1$。因此，$y = 0$和$x = 1$是方程的解。

我们现在转向BOE右侧的优化问题。式(3.1)中的BOE可以简明地写为：

$$v(s)=\max_{\pi(s)\in\Pi(s)}\sum_{a\in A}\pi(a|s)q(s,a),\quad s\in\mathcal{S}.$$

受例$3.1$的启发，我们可以首先在右侧求解最优$\pi$。那怎么办呢？下面的示例演示了它的基本思想。